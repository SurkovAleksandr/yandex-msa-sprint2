stages:
  - build
  - test
  - deploy
  - tag

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: task4-booking-service

build:
  stage: build
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG ./booking-service


test:
  stage: test
  script:
    - docker run -d --name test-container -p 8080:8080 $IMAGE_NAME:$IMAGE_TAG
    - curl -sSf "http://localhost:8080/ping" | grep -q 'pong' && echo "Urrrraaa" || echo "No pong"
    - docker rm -f test-container


deploy:
  stage: deploy
  script:
    - minikube image load $IMAGE_NAME:$IMAGE_TAG
    - helm upgrade booking-service ./helm/booking-service --debug


tag:
  stage: tag
  script:
    - TIMESTAMP=$(date +%Y%m%d%H%M%S)
    - git tag -a "v1.0-$TIMESTAMP" -m "Release created at $TIMESTAMP"

 