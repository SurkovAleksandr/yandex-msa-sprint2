### ADR-001: Задание 1. Проработка миграции от монолита к микросервисам 
### Автор: Сурков Александр
### Дата: 09.08.2025

## 1. Контекст
Сервис Hotelio реализован как единое приложение, в котором все бизнес-функции собраны в одном коде, разворачиваются как единый сервис и используют одну базу данных.

С ростом бизнеса возникли серьёзные архитектурные и операционные проблемы. Команда приняла решение о переходе на микросервисную архитектуру с постепенным выносом сервисов.

```plantuml
@startuml 
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Текущая архитектура системы Hotelio

System_Boundary(hotelio, "Hotelio Monolith") {

  Container(monolith, "Monolith Application", "Spring Boot", "Legacy app exposing REST endpoints for hotel booking") {

    ' Controllers
    Component(bookingController, "BookingController", "Spring MVC", "/api/bookings")
    Component(hotelController, "HotelController", "Spring MVC", "/api/hotels")
    Component(promoController, "PromoCodeController", "Spring MVC", "/api/promos")
    Component(reviewController, "ReviewController", "Spring MVC", "/api/reviews")
    Component(userController, "UserController", "Spring MVC", "/api/users")

    ' Services
    Component(bookingService, "BookingService", "Java Service", "Validates and creates bookings")
    Component(hotelService, "HotelService", "Java Service", "Retrieves hotel details")
    Component(userService, "UserService", "Java Service", "Validates user status and blacklist")
    Component(promoService, "PromoCodeService", "Java Service", "Applies discounts and rules")
    Component(reviewService, "ReviewService", "Java Service", "Manages hotel reviews")

    ' DB
    ComponentDb(postgres, "Monolith DB", "PostgreSQL", "Stores users, hotels, bookings, reviews, promos")

    ' Controller-Service relations
    Rel(bookingController, bookingService, "Uses")
    Rel(hotelController, hotelService, "Uses")
    Rel(promoController, promoService, "Uses")
    Rel(reviewController, reviewService, "Uses")
    Rel(userController, userService, "Uses")

    ' Service-Service and Service-DB
    Rel(bookingService, hotelService, "Calls")
    Rel(bookingService, userService, "Calls")
    Rel(bookingService, promoService, "Calls")
    Rel(bookingService, reviewService, "Calls")

    Rel(bookingService, postgres, "Reads/Writes")
    Rel(userService, postgres, "Reads")
    Rel(hotelService, postgres, "Reads")
    Rel(promoService, postgres, "Reads")
    Rel(reviewService, postgres, "Reads/Writes")
  }
}

Person(user, "User", "Interacts with frontend")
Rel(user, bookingController, "Uses")
Rel(user, hotelController, "Uses")
Rel(user, promoController, "Uses")
Rel(user, reviewController, "Uses")
Rel(user, userController, "Uses")
@enduml 
```

### Назначение модулей:
#### BookingService
Обрабатывает создание бронирований. Выполняет все проверки: пользователя, отеля, промокода, отзывов. Вычисляет финальную цену, скидку и сохраняет результат.
#### UserService
Проверяет статус пользователя: активен ли он, не находится ли в чёрном списке. И возвращает его статус.
#### HotelService
Предоставляет информацию об отелях. Используется для валидации бронирования и отображения информации в интерфейсе.
#### PromoCodeService
Проверяет промокоды: действительность, применимость к конкретному пользователю.
#### ReviewService
Отвечает за отзывы и рейтинг отеля. Влияет на возможность бронирования, если у отеля плохая репутация.

### Цели бизнеса
Начать поэтапный переход к микросервисной архитектуре, применяя паттерн Strangler Fig, — выносить по одному компоненту, оставляя остальной функционал в монолите.
подготовить архитектурный анализ и план начала миграции на микросервисы.


## 2. Функциональные требования
На текущем этапе новых функциональных требований к системе нет. Необходимо начать переход на микросервисную архитектуру без изменения текущего функционала.

## 3. Нефункциональные требования
| NFR-ID  | Требование                                                                                          |
|---------|-----------------------------------------------------------------------------------------------------|
| NFR-001 | Проанализировать текущее состояние системы и предложить план перехода на микросервисную архитектуру |
| NFR-002 | Выбрать один модуль в текущей системе, который будет первым выноситься в микросервис                |

## 4. Решение

### 4.1 Целевая архитектура
В целевой архитектуре каждый модуль в текущей архитектуре должен быть вынесен в отдельный микросервис со своей БД.

Для сокрытия инфраструктуры микросервисов и создания единой точки входа добавим шлюз. Целевая архитектура для будущей системы выглядит следующим образом.
```plantuml
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

' LAYOUT_WITH_LEGEND()

title Целевая архитектура Hotelio

System_Boundary(hotelio, "Hotelio Microservice") {

  Component(api_gateway, "API Gateway", "Kong", "API Gateway")

  Container(hotel_container, "Hotel", "Spring Boot", "Поиск отелей") {
    Component(hotelController, "HotelController", "Spring MVC", "/api/hotels")
    Component(hotelService, "HotelService", "Java Service", "Retrieves hotel details")
    ComponentDb(hotel_db, "Hotel DB", "PostgreSQL", "Stores hotels")

    Rel(hotelController, hotelService, "Uses")  
    Rel(hotelService, hotel_db, "Reads")  
  }

  Container(promo_container, "Promo", "Spring Boot", "Промокоды пользователей") {
    Component(promoController, "PromoCodeController", "Spring MVC", "/api/promos")
    Component(promoService, "PromoCodeService", "Java Service", "Applies discounts and rules")
    ComponentDb(promo_db, "Promo DB", "PostgreSQL", "Stores promos")

    Rel(promoController, promoService, "Uses") 
    Rel(promoService, promo_db, "Reads")   
  }

  Container(review_container, "Review", "Spring Boot", "Отзывы об отелях") {
    Component(reviewController, "ReviewController", "Spring MVC", "/api/reviews")  
    Component(reviewService, "ReviewService", "Java Service", "Manages hotel reviews")
    ComponentDb(eview_db, "Review DB", "PostgreSQL", "Stores reviews")

    Rel(reviewController, reviewService, "Uses")    
    Rel(reviewService, eview_db, "Reads/Writes")
  }

  Container(booking_container, "Booking", "Spring Boot", "Бронирование отелей") {
    Component(bookingController, "BookingController", "Spring MVC", "/api/bookings")
    Component(bookingService, "BookingService", "Java Service", "Validates and creates bookings")
    ComponentDb(booking_db, "Booking DB", "PostgreSQL", "Stores bookings")

    Rel(bookingController, bookingService, "Uses")
    Rel(bookingService, booking_db, "Reads/Writes")
  }

  Container(user_container, "User", "Spring Boot", "Управление пользователями") {
    Component(userController, "UserController", "Spring MVC", "/api/users")
    Component(userService, "UserService", "Java Service", "Validates user status and blacklist")
    ComponentDb(user_db, "User DB", "PostgreSQL", "Stores users")

    Rel(userController, userService, "Uses")
    Rel(userService, user_db, "Reads")
  }

  ' Service-Service and Service-DB
  Rel(bookingService, hotelService, "Calls")
  Rel(bookingService, promoService, "Calls")
  Rel(bookingService, reviewService, "Calls")

}

Person(user, "User", "Interacts with frontend")
Rel(user, api_gateway, "Gateway")
Rel(api_gateway, userController, "user")
Rel(api_gateway, bookingController, "booking")
Rel(api_gateway, hotelController, "hotel")
Rel(api_gateway, promoController, "promo")
Rel(api_gateway, reviewController, "review")


@enduml 
```

### 4.2 Вынос первого модуля в микросервис
В текущей архитектуре выделяются следующие модули:
* BookingService
* UserService
* HotelService
* PromoCodeService
* ReviewService

Эти модули покрывают основной функционал системы. Предлагаю оценить эти модули с точки зрения:
- связанность - насколько много связей модуля с другими модулями
- сложность - техническая сложность, требования к нагрузке.
- ценность для бизнеса - насколько ценен функционал для бизнеса
Оценка осуществляется по десятибальной системе, где 1 это минимальное значение, а 10 максимальное значение.

| Название модуля (потенциальный микросервис) | Связанность | Сложность | Ценности для бизнеса | Комментарий                                                                                                           |
|---------------------------------------------|-------------|-----------|----------------------|-----------------------------------------------------------------------------------------------------------------------|
| BookingService                              | 10          | 10        | 10                   | Через модуль проходят практически все связи и его стабильная работа очень ценна для бизнеса                           |
| UserService                                 | 8           | 10        | 4                    | Используется во многих процессах, сложен в реализации, но для бизнеса не важен                                        |
| HotelService                                | 8           | 6         | 10                   | Используется во многих процессах, по большей части используется только для чтения, имеет большое значение для бизнеса |
| PromoCodeService                            | 4           | 5         | 6                    | Используется в небольшом количестве процессов, средняя техническая сложность, является достаточно ценным для бизнеса  |
| ReviewService                               | 6           | 8         | 8                    | Средняя связанность, чуть выше среднего сложность, достаточно ценен для бизнеса                                       |

Исходя из того, что для выбора модуля для перенесения в микросервис выбирается наиболее простой модуль, то модули BookingService и UserService исключаем из этого выбора.

Среди оставшихся модулей самым простым является PromoCodeService. Он меньше влияет на бизнес и может быть выбран для переноса в микросервис.

```plantuml
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

'LAYOUT_WITH_LEGEND()

title Первый этап перехода на микросервисную архитектуру. Создание микросервиса PromoCode.

System_Boundary(hotelio, "Hotelio Monolith") {

  Container(monolith, "Monolith Application", "Spring Boot", "Legacy app exposing REST endpoints for hotel booking") {

    ' Controllers
    Component(bookingController, "BookingController", "Spring MVC", "/api/bookings")
    Component(hotelController, "HotelController", "Spring MVC", "/api/hotels")
    Component(reviewController, "ReviewController", "Spring MVC", "/api/reviews")
    Component(userController, "UserController", "Spring MVC", "/api/users")

    ' Services
    Component(bookingService, "BookingService", "Java Service", "Validates and creates bookings")
    Component(hotelService, "HotelService", "Java Service", "Retrieves hotel details")
    Component(userService, "UserService", "Java Service", "Validates user status and blacklist")
    
    Component(reviewService, "ReviewService", "Java Service", "Manages hotel reviews")

    ' DB
    ComponentDb(postgres, "Monolith DB", "PostgreSQL", "Stores users, hotels, bookings, reviews, promos")

    ' Controller-Service relations
    Rel(bookingController, bookingService, "Uses")
    Rel(hotelController, hotelService, "Uses")
    Rel(reviewController, reviewService, "Uses")
    Rel(userController, userService, "Uses")

    ' Service-Service and Service-DB
    Rel(bookingService, hotelService, "Calls")
    Rel(bookingService, userService, "Calls")
    Rel(bookingService, reviewService, "Calls")
    Rel(bookingService, postgres, "Reads/Writes")
    Rel(userService, postgres, "Reads")
    Rel(hotelService, postgres, "Reads")
    
    Rel(reviewService, postgres, "Reads/Writes")
  }

  Container(promocode_ms, "Promo code", "Spring Boot", "Обработка промокотов") {
    Component(promoController, "PromoCodeController", "Spring MVC", "/api/promos")
    Component(promoService, "PromoCodeService", "Java Service", "Applies discounts and rules")
    ComponentDb(promo_db, "Promo DB", "PostgreSQL", "Stores promos")
  }

  Rel(promoController, promoService, "Uses")
  Rel(promoService, promo_db, "Reads")
  Rel(bookingService, promoService, "Calls")
}

Person(user, "User", "Interacts with frontend")
Rel(user, bookingController, "Uses")
Rel(user, hotelController, "Uses")
Rel(user, promoController, "Uses")
Rel(user, reviewController, "Uses")
Rel(user, userController, "Uses")
@enduml 

```

## 5. Альтернативы
Среди модулей наиболее ценным для бизнеса является модуль HotelService. В то же время он является наиболее нагруженным. Вынесение этого модуля позволит снизить нагрузку с БД монолита и воспользоваться преимуществами масштабирования микросервиса.

**Недостатки, ограничения, риски**

Подробно опишите здесь недостатки, ограничения и риски выбранного решения.

